{% extends "base.html" %}

{% block title %}Active Question Chats - SecureSphere{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">
                                <i class="bi bi-chat-dots me-2"></i>Active Question Chats
                            </h4>
                            <p class="mb-0 opacity-75">Your ongoing conversations with security reviewers</p>
                        </div>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light">
                            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    {% if chats %}
                        <!-- Group chats by product and dimension -->
                        {% set products_chats = {} %}
                        {% for chat in chats %}
                            {% if chat.product.id not in products_chats %}
                                {% set _ = products_chats.update({chat.product.id: {'product': chat.product, 'dimensions': {}}}) %}
                            {% endif %}
                            {% if chat.response.section not in products_chats[chat.product.id]['dimensions'] %}
                                {% set _ = products_chats[chat.product.id]['dimensions'].update({chat.response.section: []}) %}
                            {% endif %}
                            {% set _ = products_chats[chat.product.id]['dimensions'][chat.response.section].append(chat) %}
                        {% endfor %}

                        <!-- Display organized chats -->
                        {% for product_id, product_data in products_chats.items() %}
                        <div class="mb-5">
                            <!-- Product Header -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="flex-grow-1">
                                    <h5 class="mb-0 text-primary">
                                        <i class="bi bi-box-seam me-2"></i>{{ product_data.product.name }}
                                    </h5>
                                    <small class="text-muted">
                                        {% set total_chats = product_data.dimensions.values() | map('length') | sum %}
                                        {{ total_chats }} active chat{{ 's' if total_chats != 1 else '' }}
                                    </small>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="badge bg-light text-dark">{{ product_data.dimensions | length }} dimension{{ 's' if product_data.dimensions | length != 1 else '' }}</span>
                                </div>
                            </div>

                            <!-- Dimensions Accordion -->
                            <div class="accordion" id="product-{{ product_id }}-accordion">
                                {% for dimension_name, dimension_chats in product_data.dimensions.items() %}
                                <div class="accordion-item border-0 shadow-sm mb-3">
                                    <h2 class="accordion-header" id="heading-{{ product_id }}-{{ loop.index0 }}">
                                        <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapse-{{ product_id }}-{{ loop.index0 }}" 
                                                aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" 
                                                aria-controls="collapse-{{ product_id }}-{{ loop.index0 }}">
                                            <div class="d-flex align-items-center justify-content-between w-100 me-3">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-folder me-2"></i>
                                                    <strong>{{ dimension_name }}</strong>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="badge bg-primary">{{ dimension_chats | length }} chat{{ 's' if dimension_chats | length != 1 else '' }}</span>
                                                    {% set unread_count = dimension_chats | selectattr('unread_messages_for_client', 'gt', 0) | list | length %}
                                                    {% if unread_count > 0 %}
                                                        <span class="badge bg-danger">{{ unread_count }} unread</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapse-{{ product_id }}-{{ loop.index0 }}" 
                                         class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                                         aria-labelledby="heading-{{ product_id }}-{{ loop.index0 }}" 
                                         data-bs-parent="#product-{{ product_id }}-accordion">
                                        <div class="accordion-body p-3">
                                            <div class="row">
                                                <!-- Sort chats: Priority order: unread > needs_revision/rejected > pending > completed -->
                                                {% set priority_order = {'needs_revision': 1, 'rejected': 2, 'pending': 3, 'completed': 4} %}
                                                {% set sorted_chats = dimension_chats | sort(attribute='updated_at', reverse=true) | sort(attribute='unread_messages_for_client', reverse=true) %}
                                                {% set final_sorted = [] %}
                                                {% for status in ['needs_revision', 'rejected', 'pending', 'completed'] %}
                                                    {% for chat in sorted_chats %}
                                                        {% if chat.review_status == status %}
                                                            {% set _ = final_sorted.append(chat) %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}
                                                {% for chat in final_sorted %}
                                                <div class="col-12 col-md-6 col-lg-4 mb-3">
                                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                                        <div class="card-header d-flex justify-content-between align-items-center p-3
                                                            {% if chat.review_status == 'needs_revision' %}bg-warning text-white
                                                            {% elif chat.review_status == 'rejected' %}bg-danger text-white
                                                            {% elif chat.review_status == 'completed' %}bg-success text-white
                                                            {% else %}bg-secondary text-white{% endif %}">
                                                            
                                                            <div class="d-flex align-items-center">
                                                                <i class="bi 
                                                                    {% if chat.review_status == 'needs_revision' %}bi-pencil-square
                                                                    {% elif chat.review_status == 'rejected' %}bi-x-circle-fill
                                                                    {% elif chat.review_status == 'completed' %}bi-check-circle-fill
                                                                    {% else %}bi-clock-fill{% endif %} me-2"></i>
                                                                <span class="fw-bold" style="color: #fff !important; font-weight: 700;">
                                                                    {% if chat.review_status == 'completed' %}Completed
                                                                    {% else %}{{ chat.review_status.replace('_', ' ').title() }}
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                            
                                                            {% if chat.unread_messages_for_client > 0 %}
                                                                <span class="badge bg-danger">{{ chat.unread_messages_for_client }}</span>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div class="card-body p-3">
                                                            <h6 class="card-title text-dark mb-2">
                                                                <i class="bi bi-question-circle me-1"></i>Question
                                                                {% if chat.response.question | question_number %}
                                                                #{{ chat.response.question | question_number }}
                                                                {% endif %}
                                                            </h6>
                                                            
                                                            <p class="card-text small text-muted mb-3" style="max-height: 60px; overflow: hidden;">
                                                                {{ chat.response.question[:100] }}{% if chat.response.question|length > 100 %}...{% endif %}
                                                            </p>
                                                            
                                                            <div class="row g-2 mb-3">
                                                                <div class="col-12">
                                                                    <small class="text-muted">
                                                                        <strong>Your Answer:</strong><br>
                                                                        <span class="badge bg-info">{{ chat.response.answer }}</span>
                                                                    </small>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row g-2 mb-3">
                                                                <div class="col-6">
                                                                    <small class="text-muted">
                                                                        <strong>Messages:</strong><br>
                                                                        {{ chat.messages.count() }} total
                                                                    </small>
                                                                </div>
                                                                <div class="col-6">
                                                                    <small class="text-muted">
                                                                        <strong>Updated:</strong><br>
                                                                        {{ chat.updated_at.strftime('%m/%d %H:%M') }}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="card-footer bg-transparent border-0 p-3 pt-0">
                                                            <div class="d-grid gap-2">
                                                                {% if chat.review_status == 'rejected' %}
                                                                <a href="{{ url_for('reselect_question', response_id=chat.response.id) }}" 
                                                                   class="btn btn-danger btn-sm">
                                                                    <i class="bi bi-arrow-repeat me-1"></i>Re-select Answer
                                                                </a>
                                                                {% elif chat.review_status == 'completed' %}
                                                                <a href="{{ url_for('view_question_chat', chat_id=chat.id) }}" 
                                                                   class="btn btn-success btn-sm">
                                                                    <i class="bi bi-check-circle me-1"></i>View Response
                                                                </a>
                                                                {% else %}
                                                                <a href="{{ url_for('view_question_chat', chat_id=chat.id) }}" 
                                                                   class="btn btn-primary btn-sm">
                                                                    <i class="bi bi-chat-dots me-1"></i>View Conversation
                                                                </a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        

                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-chat-dots display-1 text-muted"></i>
                            </div>
                            <h5 class="text-muted mb-3">No Active Question Chats</h5>
                            <p class="text-muted">
                                Question chats are created when a security reviewer marks your answer as "Needs Revision" or "Rejected". 
                                When this happens, you'll be able to discuss the question here.
                            </p>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hover-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.stat-item {
    padding: 1rem;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card-header.bg-warning,
.card-header.bg-danger,
.card-header.bg-secondary {
    border: none;
}

@media (max-width: 768px) {
    .display-6 {
        font-size: 2rem;
    }
}
</style>

<script>
// Auto-refresh page every 30 seconds to show new messages
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}