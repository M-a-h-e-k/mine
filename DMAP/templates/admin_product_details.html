{% extends "base.html" %}

{% block title %}Product Details - SecureSphere{% endblock %}

{% block content %}
<div class="dashboard-header text-center mb-4">
    <h1 class="display-6 fw-bold mb-2">
        <i class="bi bi-clipboard-data me-3"></i>{{ product.name }} - Assessment Details
    </h1>
    <p class="lead mb-0">Owner: {{ owner.username }} | Overall Maturity: {{ "%.2f"|format(overall_score) }}/5.0 ({{ maturity_level }})</p>
</div>

<!-- Product Stats -->
<div class="dashboard-stats">
    <div class="card stat-card text-center">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-8">
                    <h3 class="mb-0">{{ responses|length }}</h3>
                    <p class="mb-0">Total Responses</p>
                </div>
                <div class="col-4">
                    <i class="bi bi-chat-square-text icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card stat-card text-center">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-8">
                    <h3 class="mb-0">{{ responses|groupby('section')|list|length }}</h3>
                    <p class="mb-0">Sections</p>
                </div>
                <div class="col-4">
                    <i class="bi bi-layers icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card stat-card text-center">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-8">
                    <h3 class="mb-0">{{ responses|selectattr('comment')|list|length }}</h3>
                    <p class="mb-0">With Comments</p>
                </div>
                <div class="col-4">
                    <i class="bi bi-chat-left-dots icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>Product Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Application Name</h6>
                            <p class="mb-0">{{ product.application_name or product.name or 'Not specified' }}</p>
                        </div>
                        
                        {% if product.description %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Description</h6>
                            <p class="mb-0">{{ product.description }}</p>
                        </div>
                        {% endif %}
                        
                        {% if product.product_owner %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Product Owner</h6>
                            <p class="mb-0">{{ product.product_owner }}</p>
                        </div>
                        {% endif %}
                        
                        {% if product.business_criticality %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Business Criticality</h6>
                            <span class="badge bg-{{ 'danger' if product.business_criticality == 'High' else 'warning' if product.business_criticality == 'Medium' else 'success' }}">
                                {{ product.business_criticality }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        {% if product.product_url %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Product URL</h6>
                            <a href="{{ product.product_url }}" target="_blank" class="text-primary">
                                <i class="bi bi-link-45deg me-1"></i>{{ product.product_url }}
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if product.programming_language %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Programming Language</h6>
                            <span class="badge bg-info">{{ product.programming_language }}</span>
                        </div>
                        {% endif %}
                        
                        {% if product.cloud_platform %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Cloud Platform</h6>
                            <span class="badge bg-primary">{{ product.cloud_platform }}</span>
                        </div>
                        {% endif %}
                        
                        {% if product.cicd_platform %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">CI/CD Platform</h6>
                            <span class="badge bg-secondary">{{ product.cicd_platform }}</span>
                        </div>
                        {% endif %}
                        
                        {% if product.additional_details %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Additional Details</h6>
                            <p class="mb-0">{{ product.additional_details }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Product Creation Questions - All 10 Questions -->
                <hr class="my-4">
                <h6 class="text-muted mb-3">Client Provided Information (10 Questions)</h6>
                <div class="row">
                    {% set questions = [
                        'Brief description of the application, users and its business purpose?',
                        'How does the application handle user authentication and authorization?',
                        'What are the primary programming languages, frameworks, and databases used?',
                        'Where is the application\'s source code hosted? Please provide a link to the main repository.',
                        'Where is this application deployed?',
                        'Is there an automated CI/CD pipeline in place? If yes, which tool is used?',
                        'What is the highest sensitivity level of the data this application processes or stores?',
                        'Are any security scans currently being run against this application?',
                        'Does the application rely on any critical third-party services or APIs?',
                        'Is this application subject to any specific regulatory or compliance standards?'
                    ] %}
                    
                    {% for i in range(1, 11) %}
                        {% set category_field = 'q' + i|string + '_category' %}
                        {% set description_field = 'q' + i|string + '_description' %}
                        {% set other_field = 'q' + i|string + '_other' %}
                        {% set category = product[category_field] %}
                        {% set description = product[description_field] %}
                        {% set other = product[other_field] %}
                        {% set question_text = questions[i-1] %}
                        
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body py-3">
                                    <div class="mb-2">
                                        <span class="badge bg-primary me-2">{{ i }}</span>
                                        <small class="text-muted fw-semibold">{{ question_text }}</small>
                                    </div>
                                    {% if category %}
                                    <div class="mb-2">
                                        <span class="badge bg-success">{{ category }}</span>
                                        {% if other %}
                                        <span class="badge bg-info">{{ other }}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% if description %}
                                    <p class="mb-0 small text-dark">{{ description }}</p>
                                    {% else %}
                                    <p class="mb-0 small text-muted fst-italic">No description provided</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Dimension-wise Analysis -->
{% if dimension_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart me-2"></i>Security Dimensions Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for section, data in dimension_data.items() %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="dimension-icon mb-3">
                                    <i class="bi bi-shield-check fs-1 text-primary"></i>
                                </div>
                                <h6 class="card-title">{{ section }}</h6>
                                <div class="dimension-score mb-2">
                                    <span class="h4 text-primary">{{ "%.2f"|format(data.average_score) }}</span>
                                    <span class="text-muted">/5.0</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-gradient-primary" 
                                         style="width: {{ (data.average_score / 5.0 * 100)|round }}%"></div>
                                </div>
                                <small class="text-muted">{{ data.questions_count }} questions</small>
                                <div class="mt-2">
                                    {% if data.average_score >= 4.5 %}
                                        <span class="badge bg-success">Level 5 - Optimized</span>
                                    {% elif data.average_score >= 3.5 %}
                                        <span class="badge bg-info">Level 4 - Managed</span>
                                    {% elif data.average_score >= 2.5 %}
                                        <span class="badge bg-warning">Level 3 - Defined</span>
                                    {% elif data.average_score >= 1.5 %}
                                        <span class="badge bg-secondary">Level 2 - Developing</span>
                                    {% else %}
                                        <span class="badge bg-danger">Level 1 - Initial</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}



<!-- Lead-Client Communications -->
{% if communications_by_dimension %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots me-2"></i>Lead-Client Communications
                    </h5>
                    <select class="form-select form-select-sm" id="dimensionFilter" style="width: auto; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                        <option value="">All Dimensions</option>
                        {% for dimension in communications_by_dimension.keys() %}
                        <option value="{{ dimension }}">{{ dimension }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% for dimension, communications in communications_by_dimension.items() %}
                    <div class="mb-4" data-dimension="{{ dimension }}">
                        <div class="d-flex align-items-center mb-3">
                            <h6 class="mb-0 text-primary">
                                <i class="bi bi-collection me-2"></i>{{ dimension }}
                            </h6>
                            <span class="badge bg-primary ms-2">{{ communications|length }} conversation{{ 's' if communications|length != 1 else '' }}</span>
                        </div>
                        
                        {% for thread in communications %}
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ thread.root_comment.lead.username }}</strong> 
                                            <i class="bi bi-arrow-left-right mx-2"></i> 
                                            <strong>{{ thread.root_comment.client.username }}</strong>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-{{ 'success' if thread.root_comment.status == 'approved' else 'warning' if thread.root_comment.status == 'pending' else 'danger' }}">
                                                {{ thread.root_comment.status.replace('_', ' ').title() }}
                                            </span>
                                            {% if thread.unread_count > 0 %}
                                                <span class="badge bg-primary">{{ thread.unread_count }} unread</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if thread.root_comment.response %}
                                        <small class="text-muted">
                                            Question: {{ thread.root_comment.response.question[:80] }}{% if thread.root_comment.response.question|length > 80 %}...{% endif %}
                                        </small>
                                    {% endif %}
                                </div>
                                <div class="card-body">
                                    <!-- Root Comment -->
                                    <div class="mb-3 p-3 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-person-badge text-primary me-2"></i>
                                                <strong>{{ thread.root_comment.lead.username }}</strong>
                                                <small class="text-muted ms-2">(Lead)</small>
                                            </div>
                                            <small class="text-muted">{{ thread.root_comment.created_at.strftime('%m/%d/%Y %I:%M %p') }}</small>
                                        </div>
                                        <p class="mb-0">{{ thread.root_comment.comment }}</p>
                                    </div>
                                    
                                    <!-- Replies -->
                                    {% if thread.replies %}
                                        {% for reply in thread.replies %}
                                            <div class="mb-3 p-3 {{ 'bg-info bg-opacity-10' if reply.status in ['client_reply', 'client_response'] else 'bg-primary bg-opacity-10' }} rounded">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div class="d-flex align-items-center">
                                                        {% if reply.status in ['client_reply', 'client_response'] %}
                                                            <i class="bi bi-person-circle text-success me-2"></i>
                                                            <strong>{{ reply.client.username }}</strong>
                                                            <small class="text-muted ms-2">(Client)</small>
                                                        {% else %}
                                                            <i class="bi bi-person-badge text-primary me-2"></i>
                                                            <strong>{{ reply.lead.username }}</strong>
                                                            <small class="text-muted ms-2">(Lead)</small>
                                                        {% endif %}
                                                    </div>
                                                    <small class="text-muted">{{ reply.created_at.strftime('%m/%d/%Y %I:%M %p') }}</small>
                                                </div>
                                                <p class="mb-0">{{ reply.comment }}</p>
                                                
                                                <!-- Evidence if available -->
                                                {% if reply.status in ['client_reply', 'client_response'] and reply.response and reply.response.evidence_path %}
                                                    <div class="mt-2 p-2 bg-white rounded">
                                                        <small class="text-primary">
                                                            <i class="bi bi-paperclip me-1"></i>
                                                            <a href="{{ url_for('uploaded_file', filename=reply.response.evidence_path.split('/')[-1]) }}" target="_blank">
                                                                Evidence Attached
                                                            </a>
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        Last activity: {{ thread.last_activity.strftime('%m/%d/%Y %I:%M %p') }}
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}



<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('admin_product_results', product_id=product_id) }}" class="btn btn-primary rounded-pill px-4 me-3">
            <i class="bi bi-bar-chart me-2"></i>View Results Dashboard
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<script>
// Removed search and filter functionality as per requirements

// Dimension filter functionality
document.getElementById('dimensionFilter')?.addEventListener('change', function() {
    const selectedDimension = this.value;
    const dimensionSections = document.querySelectorAll('[data-dimension]');
    
    dimensionSections.forEach(section => {
        const dimensionName = section.getAttribute('data-dimension');
        if (!selectedDimension || dimensionName === selectedDimension) {
            section.style.display = '';
        } else {
            section.style.display = 'none';
        }
    });
});

// Animation for stats cards
document.addEventListener('DOMContentLoaded', function() {
    const statsCards = document.querySelectorAll('.stat-card');
    statsCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.transform = 'translateY(-5px)';
        }, index * 200);
    });
});
</script>
{% endblock %}